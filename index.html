<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duo Board</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #faf9f6; color: #333; }
        h1, .post-content { font-family: 'Lora', serif; }
        .post-card { transition: all 0.3s ease; border: 1px solid #e5e1da; }
        .post-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .btn-primary { background-color: #5b6d5b; color: white; transition: background 0.3s; }
        .btn-primary:hover { background-color: #4a5a4a; }
        #auth-view, #board-view { display: none; }
    </style>
</head>
<body class="min-h-screen py-12 px-4">

    <!-- Auth View -->
    <div id="auth-view" class="max-w-md mx-auto text-center space-y-6 mt-20">
        <h1 class="text-3xl font-semibold mb-8">The Private Board</h1>
        <div class="space-y-4">
            <input type="email" id="email" placeholder="Email" class="w-full p-4 border rounded-xl focus:outline-none focus:ring-1 focus:ring-stone-400">
            <input type="password" id="password" placeholder="Password" class="w-full p-4 border rounded-xl focus:outline-none focus:ring-1 focus:ring-stone-400">
            <button onclick="handleLogin()" class="w-full btn-primary p-4 rounded-xl font-medium">Enter Space</button>
        </div>
    </div>

    <!-- Board View -->
    <div id="board-view" class="max-w-2xl mx-auto">
        <header class="mb-16 text-center">
            <h1 class="text-4xl italic text-stone-800">Our Space</h1>
            <button onclick="handleLogout()" class="text-xs text-stone-400 mt-6 hover:underline uppercase tracking-widest">Sign Out</button>
        </header>

        <!-- New Post Form -->
        <div class="bg-white p-8 rounded-3xl shadow-sm mb-16 border border-stone-100">
            <textarea id="post-content" rows="3" placeholder="Add a note to the board..." class="w-full resize-none border-none focus:ring-0 text-xl post-content placeholder-stone-300"></textarea>
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mt-6 pt-6 border-t border-stone-50 gap-4">
                <input type="file" id="post-image" accept="image/*" class="text-xs text-stone-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:bg-stone-100 file:text-stone-600 hover:file:bg-stone-200">
                <button onclick="createPost()" id="post-btn" class="btn-primary px-8 py-3 rounded-full font-medium w-full sm:w-auto">Post Note</button>
            </div>
        </div>

        <!-- Posts Feed -->
        <div id="posts-container" class="space-y-10">
            <!-- Posts injected here -->
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bqiyfewuempqfymearrw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Use your actual key

        // FIX: renamed 'supabase' to 'supabaseClient' to avoid shadowing the global library object
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function checkUser() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                showView('board-view');
                loadPosts();
                subscribe();
            } else {
                showView('auth-view');
            }
        }

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) alert(error.message);
            else checkUser();
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            location.reload();
        }

        function showView(viewId) {
            document.getElementById('auth-view').style.display = viewId === 'auth-view' ? 'block' : 'none';
            document.getElementById('board-view').style.display = viewId === 'board-view' ? 'block' : 'none';
        }

        async function loadPosts() {
            const { data, error } = await supabaseClient
                .from('posts')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (data) {
                const container = document.getElementById('posts-container');
                container.innerHTML = data.map(post => renderPost(post)).join('');
            }
        }

        function renderPost(post) {
            const date = new Date(post.created_at).toLocaleDateString('en-US', { 
                month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
            });
            return `
                <div class="post-card bg-white p-10 rounded-3xl">
                    <p class="text-stone-400 text-[10px] mb-6 uppercase tracking-[0.2em] font-medium">${date}</p>
                    <div class="post-content text-2xl text-stone-800 leading-relaxed whitespace-pre-wrap">${post.content}</div>
                    ${post.image_url ? `<img src="${post.image_url}" class="mt-8 rounded-2xl w-full h-auto shadow-sm">` : ''}
                </div>
            `;
        }

        async function createPost() {
            const contentInput = document.getElementById('post-content');
            const imageInput = document.getElementById('post-image');
            const btn = document.getElementById('post-btn');
            
            if (!contentInput.value && !imageInput.files[0]) return;
            
            btn.disabled = true;
            btn.innerText = "Posting...";

            let image_url = null;
            if (imageInput.files[0]) {
                const file = imageInput.files[0];
                const fileName = `${Date.now()}-${file.name}`;
                const { data, error } = await supabaseClient.storage.from('post-images').upload(fileName, file);
                if (data) {
                    const { data: urlData } = supabaseClient.storage.from('post-images').getPublicUrl(fileName);
                    image_url = urlData.publicUrl;
                }
            }

            const { error } = await supabaseClient.from('posts').insert([{ content: contentInput.value, image_url }]);
            
            if (error) alert(error.message);
            
            contentInput.value = '';
            imageInput.value = '';
            btn.disabled = false;
            btn.innerText = "Post Note";
        }

        function subscribe() {
            supabaseClient.channel('board-updates')
            .on('postgres_changes', { event: 'INSERT', table: 'posts' }, payload => {
                const container = document.getElementById('posts-container');
                container.insertAdjacentHTML('afterbegin', renderPost(payload.new));
            })
            .subscribe();
        }

        checkUser();
    </script>
</body>
</html>
