<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Board</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fcfaf8; color: #333; }
        h1, .post-content { font-family: 'Lora', serif; }
        .post-card { border: 1px solid #e5e1da; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-primary { background-color: #5b6d5b; color: white; }
        #auth-view, #board-view { display: none; }
    </style>
</head>
<body class="min-h-screen py-10 px-4">

    <!-- Login View -->
    <div id="auth-view" class="max-w-md mx-auto text-center space-y-6 mt-20">
        <h1 class="text-3xl font-semibold mb-8 italic">Shared Space</h1>
        <div class="bg-white p-8 rounded-2xl border shadow-sm space-y-4">
            <input type="text" id="username" placeholder="Username" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-1 focus:ring-stone-400">
            <input type="password" id="password" placeholder="Password" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-1 focus:ring-stone-400">
            <button onclick="handleLogin()" class="w-full btn-primary p-3 rounded-lg font-medium">Enter Board</button>
        </div>
    </div>

    <!-- Board View -->
    <div id="board-view" class="max-w-2xl mx-auto">
        <header class="mb-12 flex justify-between items-end">
            <div>
                <h1 class="text-4xl italic text-stone-800">Corkboard</h1>
                <p id="user-greeting" class="text-stone-400 text-sm mt-1"></p>
            </div>
            <button onclick="handleLogout()" class="text-xs text-stone-300 hover:text-stone-500 uppercase tracking-tighter">Sign Out</button>
        </header>

        <!-- New Post Form -->
        <div class="bg-white border p-6 rounded-2xl shadow-sm mb-12">
            <textarea id="post-content" rows="3" placeholder="Leave a note..." class="w-full resize-none border-none focus:ring-0 text-lg post-content"></textarea>
            <div class="flex items-center justify-between mt-4 border-t pt-4">
                <input type="file" id="post-image" accept="image/*" class="text-xs text-stone-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:bg-stone-50 file:text-stone-600">
                <button onclick="createPost()" id="post-btn" class="btn-primary px-6 py-2 rounded-full font-medium">Post note</button>
            </div>
        </div>

        <!-- Posts Feed -->
        <div id="posts-container" class="space-y-8 pb-20">
            <!-- Posts Injected Here -->
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bqiyfewuempqfymearrw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxaXlmZXd1ZW1wcWZ5bWVhcnJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0Mzg3MzksImV4cCI6MjA4NDAxNDczOX0.He0wDj2TIfOUb7pMCOO5FIIJC1zzmnuponKhh-1rtcM';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = localStorage.getItem('board_user');

        function checkAuth() {
            if (currentUser) {
                document.getElementById('user-greeting').innerText = `Logged in as ${currentUser}`;
                showView('board-view');
                loadPosts();
                subscribe();
            } else {
                showView('auth-view');
            }
        }

        async function handleLogin() {
            const userIn = document.getElementById('username').value;
            const passIn = document.getElementById('password').value;

            const { data, error } = await supabaseClient
                .from('members')
                .select('*')
                .eq('username', userIn)
                .eq('password', passIn)
                .single();

            if (data) {
                localStorage.setItem('board_user', data.username);
                currentUser = data.username;
                checkAuth();
            } else {
                alert("Incorrect username or password.");
            }
        }

        function handleLogout() {
            localStorage.removeItem('board_user');
            location.reload();
        }

        function showView(viewId) {
            document.getElementById('auth-view').style.display = viewId === 'auth-view' ? 'block' : 'none';
            document.getElementById('board-view').style.display = viewId === 'board-view' ? 'block' : 'none';
        }

        async function loadPosts() {
            const { data } = await supabaseClient
                .from('posts')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (data) {
                const container = document.getElementById('posts-container');
                container.innerHTML = data.map(post => renderPost(post)).join('');
            }
        }

        function renderPost(post) {
            const date = new Date(post.created_at).toLocaleDateString('en-US', { 
                month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
            });
            return `
                <div class="post-card bg-white p-8 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[10px] uppercase tracking-widest text-stone-400">${post.author_name}</span>
                        <span class="text-[10px] text-stone-300">${date}</span>
                    </div>
                    <div class="post-content text-xl text-stone-800 leading-relaxed whitespace-pre-wrap">${post.content}</div>
                    ${post.image_url ? `<img src="${post.image_url}" class="mt-6 rounded-xl w-full h-auto grayscale-[20%]">` : ''}
                </div>
            `;
        }

        async function createPost() {
            const content = document.getElementById('post-content').value;
            const imageFile = document.getElementById('post-image').files[0];
            const btn = document.getElementById('post-btn');
            
            if (!content && !imageFile) return;
            btn.disabled = true;
            btn.innerText = "...";

            let image_url = null;
            if (imageFile) {
                const fileName = `${Date.now()}-${imageFile.name}`;
                const { data } = await supabaseClient.storage.from('post-images').upload(fileName, imageFile);
                if (data) {
                    const { data: urlData } = supabaseClient.storage.from('post-images').getPublicUrl(fileName);
                    image_url = urlData.publicUrl;
                }
            }

            const { error } = await supabaseClient.from('posts').insert([
                { content, image_url, author_name: currentUser }
            ]);

            if (!error) {
                document.getElementById('post-content').value = '';
                document.getElementById('post-image').value = '';
            }
            btn.disabled = false;
            btn.innerText = "Post note";
        }

        function subscribe() {
            supabaseClient.channel('board-realtime')
            .on('postgres_changes', { event: 'INSERT', table: 'posts' }, payload => {
                const container = document.getElementById('posts-container');
                container.insertAdjacentHTML('afterbegin', renderPost(payload.new));
            })
            .subscribe();
        }

        checkAuth();
    </script>
</body>
</html>
